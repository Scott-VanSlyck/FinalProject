title: "ST 558: Final Project (Modeling)"
authors: "Scott Van Slyck"
description: "Modeling File for Final Project"
date: "July 29, 2024"
format: html
editor: visual
---

```{r}
#| echo: FALSE

packages <- c("tidyverse", "caret", "glmnet", "MASS")

install_if_missing <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

lapply(packages, install_if_missing)
```

## Introduction

In this project, we are working with a dataset from the Diabetes Health Indicators to predict the diabetes status of individuals. The response variable, `Diabetes_binary`, indicates whether or not a patient has diabetes.  Our goal is to create predictive models for the `Diabetes_binary` variable using various machine learning techniques. We will evaluate the models using log loss as our primary metric.

First we will start by reading in the data and splitting it into training and testing sets.
```{r}
DBH <- read_csv("preprocessed_diabetes_data.csv")

# Setting seed and splitting data into training and test sets
set.seed(270)

trainIndex <- createDataPartition(DBH$Diabetes_binary, p = 0.7, list = FALSE)

trainData <- DBH[trainIndex, ]
testData <- DBH[-trainIndex, ]
```

Log loss, also known as logistic loss or cross-entropy loss, is a measure of how well a model's predicted probabilities match the actual outcomes. It evaluates how accurate and confident a model is about it's prediction, it penalizes wrong predictions with high confidence more than one that is unsure. These penalties result in the model taking more precise and cautious estimates. Where it differs from accuracy is it provides a more detailed view of performance when considering confidence of predictions. This is useful in scenarios where predicting the majority class can give misleadingly high accuracy, focusing on probability estimates allows log loss to help create more reliable models for real-world applications where knowing the likelihood of an outcome is of utmost importance.


## Logistic Regression Models
First we will start our modeling with looking at logistic regression models. Logistic regression is a statistical method of modeling to display relationships between a binary response variable and independent variables. Logistic regression's binary outcome results in the prediction of the probability of the outcome which can be useful for risk assessment. They are easily interpretable due to the coefficients being displayed as log odds of the outcome making it easy to understand the impact of each predictor.

```{r}
# Control for cross evalution with 5-folds

train_control <- trainControl(method = "cv", number = 5, classProbs = TRUE, summaryFunction = mnLogLoss)

# Re-set seed
set.seed(270)

# Model 1: Basic Logistic Regression
log_model1 <- train(Diabetes_binary ~ ., data = trainData, method = "glm", family = "binomial", 
                    trControl = train_control, metric = "logLoss")

# Model 2: Logistic Regression with selected predictors
selected_predictors2 <- c("HighBP", "BMI", "Smoker", "PhysActivity")
formula2 <- as.formula(paste("Diabetes_binary ~", paste(selected_predictors2, collapse = " + ")))

log_model2 <- train(formula2, data = trainData, method = "glm", family = "binomial", 
                    trControl = train_control, metric = "logLoss")

# Model 3: Logistic Regression with another set of selected predictors
selected_predictors3 <- c("Veggies", "Sex", "Age", "Income")
formula3 <- as.formula(paste("Diabetes_binary ~", paste(selected_predictors3, collapse = " + ")))

log_model3 <- train(formula3, data = trainData, method = "glm", family = "binomial", 
                    trControl = train_control, metric = "logLoss")

# Compare models
resamples_log <- resamples(list(Full = log_model1, Reduced1 = log_model2, Reduced2 = log_model3))
summary(resamples_log)
```

## Classification Tree

```{r}
set.seed(270)

tree_model <- train(Diabetes_binary ~ ., data = trainData, method = "rpart", 
                    trControl = train_control, metric = "logLoss", tuneLength = 10)

# Print tree model
print(tree_model)
```

## Random Forest

```{r}
set.seed(270)

rf_grid <- expand.grid(mtry = seq(2, ncol(trainData)-1, by = 2))

rf_model <- train(Diabetes_binary ~ ., data = trainData, method = "rf", 
                  trControl = train_control, metric = "logLoss", tuneGrid = rf_grid, ntree = 100)

# Print random forest model
print(rf_model)
```

## Final Model Selection

```{r}
# Predict on the test set using the best logistic regression model
log_preds <- predict(log_model1, newdata = testData, type = "prob")
log_loss_test1 <- mnLogLoss(log_preds, testData$Diabetes_binary)

log_preds2 <- predict(log_model2, newdata = testData, type = "prob")
log_loss_test2 <- mnLogLoss(log_preds2, testData$Diabetes_binary)

log_preds3 <- predict(log_model3, newdata = testData, type = "prob")
log_loss_test3 <- mnLogLoss(log_preds3, testData$Diabetes_binary)

print(c(log_loss_test1, log_loss_test2, log_loss_test3))

# Predict on the test set using the classification tree model
tree_preds <- predict(tree_model, newdata = testData, type = "prob")
tree_loss_test <- mnLogLoss(tree_preds, testData$Diabetes_binary)
print(tree_loss_test)

# Predict on the test set using the random forest model
rf_preds <- predict(rf_model, newdata = testData, type = "prob")
rf_loss_test <- mnLogLoss(rf_preds, testData$Diabetes_binary)
print(rf_loss_test)

# Compare the log loss of all models
model_comparison <- data.frame(
  Model = c("Full Logistic Regression", "Reduced Model 1", "Reduced Model 2", "Classification Tree", "Random Forest"),
  LogLoss = c(log_loss_test1, log_loss_test2, log_loss_test3, tree_loss_test, rf_loss_test)
)
print(model_comparison)
```
